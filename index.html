-- Remove a função antiga se ela já existir, para evitar conflitos.
DROP FUNCTION IF EXISTS get_professor_assiduidade(date, date, integer, uuid);

-- Cria a nova versão da função, mais precisa
CREATE OR REPLACE FUNCTION get_professor_assiduidade(
    data_inicio date,
    data_fim date,
    ano_letivo_selecionado integer DEFAULT NULL,
    professor_uid_selecionado uuid DEFAULT NULL
)
RETURNS TABLE(dia date, status text, nome_professor text, nome_turma text)
LANGUAGE 'plpgsql'
AS $$
BEGIN
    RETURN QUERY
    WITH 
    -- 1. Gera uma série com todos os dias no intervalo, exceto fins de semana e feriados.
    dias_letivos AS (
        SELECT d::date
        FROM generate_series(data_inicio, data_fim, '1 day'::interval) d
        WHERE 
            -- Exclui Sábado (6) e Domingo (0)
            EXTRACT(DOW FROM d) NOT IN (0, 6)
            -- Exclui dias que estão marcados como eventos/feriados na tabela 'eventos'
            AND NOT EXISTS (
                SELECT 1 FROM eventos e
                WHERE d::date >= e.data AND d::date <= COALESCE(e.data_fim, e.data)
            )
    ),
    -- 2. Cria uma lista de todas as aulas que deveriam acontecer (professor + turma + dia).
    aulas_esperadas AS (
        SELECT
            dl.d,
            u.nome AS prof_nome,
            u.user_uid AS prof_uid, -- Adicionado para a junção
            t.nome_turma AS turma_nome,
            t.id AS turma_id
        FROM
            dias_letivos dl
        CROSS JOIN
            professores_turmas pt
        JOIN
            usuarios u ON pt.professor_id = u.user_uid
        JOIN
            turmas t ON pt.turma_id = t.id
        WHERE
            u.status = 'ativo'
            -- Aplica os filtros opcionais da busca
            AND (ano_letivo_selecionado IS NULL OR t.ano_letivo = ano_letivo_selecionado)
            AND (professor_uid_selecionado IS NULL OR u.user_uid = professor_uid_selecionado)
    ),
    -- 3. Obtém uma lista distinta de lançamentos feitos (dia + turma + professor).
    lancamentos_feitos AS (
        SELECT DISTINCT
            p.data,
            p.turma_id,
            p.registrado_por_uid -- Adicionado para a junção
        FROM
            presencas p
        WHERE
            p.data BETWEEN data_inicio AND data_fim
    )
    -- 4. Compara as aulas esperadas com os lançamentos feitos pelo professor específico.
    SELECT
        ae.d AS dia,
        CASE
            WHEN lf.data IS NOT NULL THEN 'Lançado'::text
            ELSE 'Não Lançado'::text
        END AS status,
        ae.prof_nome AS nome_professor,
        ae.turma_nome AS nome_turma
    FROM
        aulas_esperadas ae
    LEFT JOIN
        lancamentos_feitos lf ON ae.d = lf.data 
                             AND ae.turma_id = lf.turma_id
                             AND ae.prof_uid = lf.registrado_por_uid -- <-- LÓGICA CORRIGIDA AQUI
    ORDER BY
        ae.d,
        ae.prof_nome,
        ae.turma_nome;

END;
$$;
